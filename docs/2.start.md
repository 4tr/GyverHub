## Платформа
Библиотека компилируется и работает на всех Arduino-совместимых платформах. Для ESP8266 и ESP32 доступны дополнительные сетевые возможности

### ESP8266/ESP32
Библиотека работает на актуальных версиях SDK. Не рекомендуется ставить версии ниже указанных. Ссылки для менеджера плат:
- ESP8266 **v2.7+** https://arduino.esp8266.com/stable/package_esp8266com_index.json
- ESP32 **v2+** https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
    - **НЕ РАБОТАЕТ НА SDK 2.0.8!!!**
    - Если AsyncWebSocket не компилируется на ESP32C3 - `AsyncWebSocket.cpp` строка ~832 заменить `return IPAddress(0U)` -> `return IPAddress()`

### Если не компилируется
- Удалить Arduino IDE
- Удалить папку Arduino15: `C:\Users\USER\AppData\Local\Arduino15` (Windows)
- Удалить папку с библиотеками: `Документы\Arduino\libraries` (Windows)
- Установить всё актуальных версий

## Установка библиотеки
### GyverHub
Библиотека ещё не вышла в релиз: скачать актуальную бета-версию можно из репозитория - [прямая ссылка на архив](https://github.com/GyverLibs/GyverHub/archive/refs/heads/main.zip). [Документация](https://github.com/GyverLibs/GyverHub/wiki) всегда соответствует текущей версии на гитхаб!

<details>
<summary>Информация из будущего</summary>

- Библиотеку можно найти по названию **GyverHub** и установить через менеджер библиотек в:
    - Arduino IDE
    - Arduino IDE v2
    - PlatformIO
- [Скачать библиотеку](https://github.com/GyverLibs/GyverHub/archive/refs/heads/main.zip) .zip архивом для ручной установки:
    - Распаковать и положить в *Документы/Arduino/libraries/*
    - (Arduino IDE) автоматическая установка из .zip: *Скетч/Подключить библиотеку/Добавить .ZIP библиотеку…* и указать скачанный архив

</details>

### Ручная установка библиотек
- Вручную: распаковать и положить в *Документы/Arduino/libraries/* (Windows)
- Arduino IDE: автоматическая установка из .zip: *Скетч/Подключить библиотеку/Добавить .ZIP библиотеку…* и указать скачанный архив

### Зависимости
Для работы GyverHub нужно установить ещё несколько библиотек:
- Для всех платформ
    - [Stamp](https://github.com/GyverLibs/Stamp), [**СКАЧАТЬ**](https://github.com/GyverLibs/Stamp/archive/refs/heads/main.zip)
- Для ESP8266/32
    - Для синхронной работы:
        - [PubSubClient](https://github.com/knolleary/pubsubclient), [**СКАЧАТЬ**](https://github.com/knolleary/pubsubclient/archive/refs/heads/master.zip)
        - [arduinoWebSockets](https://github.com/Links2004/arduinoWebSockets), [**СКАЧАТЬ**](https://github.com/Links2004/arduinoWebSockets/archive/refs/heads/master.zip)
    - Для асинхронной работы:
        - [ESPAsyncWebServer](https://github.com/me-no-dev/ESPAsyncWebServer), [**СКАЧАТЬ**](https://github.com/me-no-dev/ESPAsyncWebServer/archive/refs/heads/master.zip)
        - [ESPAsyncTCP](https://github.com/me-no-dev/ESPAsyncTCP), [**СКАЧАТЬ**](https://github.com/me-no-dev/ESPAsyncTCP/archive/refs/heads/master.zip)
        - [AsyncTCP](https://github.com/me-no-dev/AsyncTCP), [**СКАЧАТЬ**](https://github.com/me-no-dev/AsyncTCP/archive/refs/heads/master.zip)
        - [async-mqtt-client](https://github.com/marvinroger/async-mqtt-client), [**СКАЧАТЬ**](https://github.com/marvinroger/async-mqtt-client/archive/refs/heads/develop.zip)

> Синхронные и асинхронные: в асинхронной версии GyverHub используются библиотеки на базе AsyncTCP. Они "тяжелее", но работают асинхронно и не тормозят работу программы в отличие от синхронных. В то же время на синхронных работа будет более стабильной, по крайней мере мне так показалось.

#### Arduino IDE
Скачать и установить библиотеки как описано выше

#### PlatformIO
Скачать и распаковать библиотеки в папку `lib` проекта или добавить зависимости в *platformio.ini*:

```dosini
lib_deps =
    ;GyverLibs/GyverHub - пока не опубликована
    ;GyverLibs/Stamp - пока не опубликована
    GyverHub=https://github.com/GyverLibs/GyverHub/archive/refs/heads/main.zip
    Stamp=https://github.com/GyverLibs/Stamp/archive/refs/heads/main.zip
    knolleary/PubSubClient
    links2004/WebSockets
    me-no-dev/AsyncTCP
    me-no-dev/ESPAsyncTCP
    me-no-dev/ESP Async WebServer
    marvinroger/AsyncMqttClient
```

## Основные понятия
### Устройство
Для настройки устройства нужно указать несколько параметров
- **Префикс сети** - уникальное имя сети, должно быть одинаковым у всех устройств и у приложения, чтобы они могли общаться друг с другом. С этого префикса также будут начинаться MQTT топики, что позволяет относительно безопасно пользоваться системой даже на публичных MQTT брокерах. *Только английские буквы, цифры, без пробелов*
- **Имя** - название устройства, которое будет отображаться в списке устройств в приложении
- **Иконка** - иконка рядом с названием. Иконки Font Awesome v5 Solid Free: [список иконок](https://fontawesome.com/v5/cheatsheet/free/solid), [поиск иконок](https://fontawesome.com/v5/search?o=r&m=free&s=solid)

### MQTT (опционально)
MQTT позволяет управлять своим устройством через интернет (из другого города или любой другой точки планеты). GyverHub работает с внешним брокером. Для использования MQTT нужно выбрать брокера и указать хост (или IP) и порт (опционально логин + пароль, см. документацию). Требования к MQTT брокеру:
- Наличие Wildcards (топики с `/#`)
- Наличие незащищённого TCP (для устройства)
- Наличие Websocket с TLS (для приложения)
- Лично я пользуюсь [WQTT](https://www.wqtt.ru/) - 300 рублей в год + интеграция с Алисой
- [Список бесплатных брокеров](https://kotyara12.ru/iot/cloud_services/)
- Для экспериментов можно использовать бесплатный публичный mosquitto, он настроен в примерах по умолчанию:
  - Хост: `test.mosquitto.org`
  - Порт (esp): `1883`
  - Порт (приложение): `8081`

> Примечание: если оставить стандартный префикс и брокера из примера ниже - иногда можно найти мои устройства =)

#### Конфиденциальность
Пароль от MQTT, как и все остальные настройки сайта/приложения, хранится исключительно в браузере, т.е. в памяти компьютера/смартфона (Local storage)

## Минимальный код
```cpp
#include <GyverHub.h>
GyverHub hub("MyDevices", "ESP8266", "");  // префикс, имя, иконка

// конструктор интерфейса
void build() {
    hub.Button(F("b1"));    // кнопка для примера
}

void setup() {
    // подключение к WiFi
    Serial.begin(115200);
    WiFi.mode(WIFI_STA);
    WiFi.begin("AP_SSID", "AP_PASS");
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("Ready!");

    hub.setupMQTT("test.mosquitto.org", 1883);  // настраиваем MQTT
    //hub.setupMQTT("m8.wqtt.ru", 13448, "****", "****");
    hub.onBuild(build);     // подключаем билдер
    hub.begin();            // запускаем систему
}

void loop() {
    hub.tick();  // обязательно тикаем тут
}
```

## Настройка сайта/приложения
- Зайти на [hub.gyver.ru](http://hub.gyver.ru/)
- Нажать шестерёнку справа
- Ввести свой префикс сети в блоке Settings

### MQTT
- Включить MQTT, ввести данные брокера (или оставить стандартные на публичном сервере). Всё, можно пользоваться
- Примечание: если после введения данных MQTT не хочет подключаться и сыпет ошибками - перезагрузить страницу
- Работает как на http, так и на https версии сайта GyverHub

Пояснение для сервиса WQTT

![image](https://user-images.githubusercontent.com/84599917/236941720-0dbe174f-dc7e-43cf-bb46-38c7d902a30c.png)  

### WS
Режим WS (WebSocket) позволяет общаться с устройством внутри локальной сети (без подключения к Интернету): вы подключены с ним к одному роутеру или ESP находится в режиме точки доступа и телефон подключен к ней. Но есть небольшая проблема - современные браузеры запрещают слать запросы на локальные адреса "в целях безопасности". Нужно:
- Отключить настройку **Block insecure private network requests** в браузере, для этого перейти по адресу `chrome://flags/#block-insecure-private-network-requests` (адрес настройки для вашей версии браузера будет указан в настройках GyverHub)
- Зайти на [http версию](http://hub.gyver.ru/) сайта GyverHub. На https версии режим WS работать не будет
- Указать локальный IP адрес устройства, на котором открыт сайт (телефон, ПК) в поле *My IP*, цифра **1** на картинке ниже, это нужно для поиска ESP в той же сети:
    - Достаточно указать адрес основного шлюза (адрес роутера), у большинства роутеров это будет `192.168.1.1`. Можно посмотреть в настройках роутера
    - Можно узнать адрес средствами сервиса GyverHub (кнопка обновить в окошке ввода IP адреса, цифра **2** на картинке ниже), для этого нужно опять же отключить настройку **Anonymize local IPs exposed by WebRTC** в браузере: `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`

![image](https://user-images.githubusercontent.com/84599917/236942206-83a337ff-d388-4bd2-80ab-e9f573952d53.png)  
![image](https://user-images.githubusercontent.com/84599917/236978360-0ae4d8f7-8b98-4265-8373-db36db41a1f3.png)

### Поиск устройств
Жмём лупу в самом первом пункте настроек, устройство должно появиться в списке

![image](https://user-images.githubusercontent.com/84599917/236940953-c5d64dd3-6302-4839-8fc2-58fdb666357b.png)  
![image](https://user-images.githubusercontent.com/84599917/236945607-75249359-33ac-4935-a741-edf7cca7ab03.png)  

- `W` - устройство доступно в локальной сети по Websocket
- `M` - устройство доступно через Интернет по MQTT
- `S` - Serial
- `B` - Bluetooth

> Приоритет: устройство откроется в том подключении, чья буква расположена левее (приоритет S, B, W, M)

## Установка веб-приложения
### HTTPS версия
Сайт GyverHub можно "установить" на любое устройство (Windows, Linux, Android, iOS...) как веб-приложение (PWA). Браузер сам предложит вам это сделать на [https](https://hub.gyver.ru/) версии сайта. На этой версии будет работать MQTT, Serial, Bluetooth, но WS работать не будет!

![image](https://user-images.githubusercontent.com/84599917/236978702-d6c25585-f645-4ed9-9407-4a7effcd5d50.png)

### HTTP версия
Для установки [http](http://hub.gyver.ru/) версии приложения нужно включить настройку `chrome://flags/#unsafely-treat-insecure-origin-as-secure` (адрес настройки для вашего браузера указан в настройках GyverHub) и добавить `http://hub.gyver.ru` в список доверенных сайтов. После этого можно будет установить PWA приложение по кнопке HTTP и пользоваться им в локальном режиме!

![image](https://user-images.githubusercontent.com/84599917/236947391-f645347d-ed6c-4911-a8ce-fb8fb1518864.png)  
![image](https://user-images.githubusercontent.com/84599917/236947679-7d7f8fe6-c71e-4d55-8717-e63034e11267.png)  

## Запуск из ESP
Сайт может работать из памяти ESP8266/32, в библиотеке для этого уже настроен веб-сервер. Если зайти на IP адрес ESP в локальной сети - GyverHub откроется из памяти ESP, точно так же как [GyverPortal](https://github.com/GyverLibs/GyverPortal).

### Из файлов
Для работы сайта нужно загрузить в файловую систему esp файлы из `/web/esp/` в папке с библиотекой. Это можно сделать через плагин для Arduino IDE, через встроенный инструмент в PlatformIO, а также через файловый менеджер в приложении GyverHub. Файлы должны располагаться в памяти по пути:
- `/hub/index.html.gz`
- `/hub/script.js.gz`
- `/hub/style.css.gz`

### Из программы
Если объявить дефайн `GH_INCLUDE_PORTAL` перед подключением библиотеки
```cpp
#define GH_INCLUDE_PORTAL
#include <GyverHub.h>
```

то необходимые для работы сайта файлы будут включены в программу в бинарном виде и прибавят к весу прошивки около 35 кБ. Больше ничего делать не нужно, GyverHub доступен по IP адресу ESP в локальной сети.

### Особенности ESP версии
- Убраны модули MQTT, Bluetooth, Serial
- Убрана возможность установить как веб-приложение
- Убран Test билдер

## Android приложение
- Доступно в [Google Play](https://play.google.com/store/apps/details?id=ru.alexgyver.GyverHub)
- [Скачать apk](https://github.com/GyverLibs/GyverHub/raw/main/app/GyverHub.apk)

> Начиная приммерно с 10 версии Android при включенной тёмной теме в приложении искажаются цвета. Отключите тёмную тему для приложения (*Настройки/Экран/Параметры тёмного режима*, снять галочку около GyverHub)