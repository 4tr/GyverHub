# Начало работы с GyverHUB

## Установка библиотеки
### GyverHUB
- Библиотеку можно найти по названию **GyverHUB** и установить через менеджер библиотек в:
    - Arduino IDE
    - Arduino IDE v2
    - PlatformIO
- [Скачать библиотеку](https://github.com/GyverLibs/GyverHUB/archive/refs/heads/main.zip) .zip архивом для ручной установки:
    - Распаковать и положить в *Документы/Arduino/libraries/*
    - (Arduino IDE) автоматическая установка из .zip: *Скетч/Подключить библиотеку/Добавить .ZIP библиотеку…* и указать скачанный архив

### Зависимости
Для работы GyverHUB нужно установить ещё несколько библиотек:
- Для всех платформ
    - [Stamp](https://github.com/GyverLibs/Stamp), [скачать архив](https://github.com/GyverLibs/Stamp/archive/refs/heads/main.zip)
- Для ESP8266/32
    - Для синхронной работы:
        - [PubSubClient](https://github.com/knolleary/pubsubclient), [скачать архив](https://github.com/knolleary/pubsubclient/archive/refs/heads/master.zip)
        - [arduinoWebSockets](https://github.com/Links2004/arduinoWebSockets), [скачать архив](https://github.com/Links2004/arduinoWebSockets/archive/refs/heads/master.zip)
    - Для асинхронной работы:
        - [ESPAsyncWebServer](https://github.com/me-no-dev/ESPAsyncWebServer), [скачать архив](https://github.com/me-no-dev/ESPAsyncWebServer/archive/refs/heads/master.zip)
        - [ESPAsyncTCP](https://github.com/me-no-dev/ESPAsyncTCP), [скачать архив](https://github.com/me-no-dev/ESPAsyncTCP/archive/refs/heads/master.zip)
        - [AsyncTCP](https://github.com/me-no-dev/AsyncTCP), [скачать архив](https://github.com/me-no-dev/AsyncTCP/archive/refs/heads/master.zip)
        - [async-mqtt-client](https://github.com/marvinroger/async-mqtt-client), [скачать архив](https://github.com/marvinroger/async-mqtt-client/archive/refs/heads/develop.zip)

> Синхронные и асинхронные: в асинхронной версии GyverHUB используются библиотеки на базе AsyncTCP. Они "тяжелее", но работают асинхронно и не тормозят работу программы в отличие от синхронных. В то же время на синхронных работа будет более стабильной, по крайней мере мне так показалось.

#### Arduino IDE
Скачайте и установите библиотеки как описано выше: в папку Документы (Windows) или через *Скетч/Подключить библиотеку/Добавить .ZIP библиотеку…*

#### PlatformIO
*platformio.ini*
```
lib_deps =
    ;GyverLibs/GyverHUB - пока не опубликована
    ;GyverLibs/Stamp - пока не опубликована
    knolleary/PubSubClient
    links2004/WebSockets
    me-no-dev/AsyncTCP
    me-no-dev/ESPAsyncTCP
    me-no-dev/ESP Async WebServer
    marvinroger/AsyncMqttClient
```

## Минимальный код
### Устройство
Для настройки устройства нужно указать несколько параметров
- **Префикс сети** - уникальное имя сети, должно быть одинаковым у всех устройств и у приложения, чтобы они могли общаться друг с другом. С этого префикса также будут начинаться MQTT топики, что позволяет относительно безопасно пользоваться системой даже на публичных MQTT брокерах
- **Имя** - название устройства, которое будет отображаться в списке устройств в приложении
- **Иконка** - иконка рядом с названием. Иконки Font Awesome v5 Solid Free: [список иконок](https://fontawesome.com/v5/cheatsheet/free/solid), [поиск иконок](https://fontawesome.com/v5/search?o=r&m=free&s=solid)

### MQTT (опционально)
MQTT позволяет управлять своим устройством через интернет (из другого города или любой другой точки планеты). Для использования MQTT нужно выбрать брокера и указать хост (или IP) и порт (опционально логин + пароль, см. документацию). Требования к MQTT брокеру:
- Наличие Wildcards (топики с `/#`)
- Наличие незащищённого TCP (для устройства)
- Наличие Websocket с TLS (для приложения)
- Лично я пользуюсь [WQTT](https://www.wqtt.ru/) - 200 рублей в год + интеграция с Алисой
- [Список бесплатных брокеров](https://kotyara12.ru/iot/cloud_services/)

> Примечание: если оставить стандартный префикс и брокера из примера ниже - иногда можно найти мои устройства =)

```cpp
#include <GyverHUB.h>
GyverHUB hub("MyDevices", "ESP8266", "");  // префикс, имя, иконка

// конструктор интерфейса
void build() {
    hub.Button(F("b1"));    // кнопка для примера
}

void setup() {
    // подключение к WiFi
    Serial.begin(115200);
    WiFi.mode(WIFI_STA);
    WiFi.begin("AP_SSID", "AP_PASS");
    while (WiFi.status() != WL_CONNECTED) {
        delay(500);
        Serial.print(".");
    }
    Serial.println("Ready!");

    hub.setupMQTT("test.mosquitto.org", 1883);  // настраиваем MQTT
    //hub.setupMQTT("m8.wqtt.ru", 13448, "****", "****");
    hub.onBuild(build);     // подключаем билдер
    hub.begin();            // запускаем систему
}

void loop() {
    hub.tick();  // обязательно тикаем тут
}
```

## Настройка сайта/приложения
- Заходим на [hub.gyver.ru](http://hub.gyver.ru/)
- Шестерёнка справа
- Вводим свой префикс сети

### MQTT
- Ставим галочку MQTT, вводим данные брокера (или оставляем стандартные на публичном сервере). Всё, можно пользоваться
- Работает как на http, так и на https версии сайта GyverHUB
Пояснение для сервиса WQTT

### Local
Режим Local позволяет общаться с устройством внутри локальной сети (без подключения к Интернету): вы подключены с ним к одному роутеру или ESP находится в режиме точки доступа и телефон подключен к ней. Но есть небольшая проблема - современные браузеры запрещают слать запросы на локальные адреса в "целях безопасности":
- [http](http://hub.gyver.ru/) версия сайта - для работы в режиме Local нужно отключить настройку **Block insecure private network requests.** в браузере `chrome://flags/#block-insecure-private-network-requests` (адрес настройки для вашего браузера указан в настройках GyverHUB)
- [https](https://hub.gyver.ru/) версия сайта - здесь работа в режиме Local невозможна

### Поиск устройств
Жмём лупу в самом первом пункте настроек, устройство должно появиться в списке

## Установка веб-приложения
Сайт GyverHUB можно "установить" на любое устройство (Windows, Linux, Android, iOS...) как веб-приложение (PWA). Браузер сам предложит вам это сделать на [https](https://hub.gyver.ru/) версии сайта. На этой версии будет работать MQTT, Serial, Bluetooth, но Local работать не будет! Для установки [http](http://hub.gyver.ru/) версии приложения нужно включить настройку `chrome://flags/#unsafely-treat-insecure-origin-as-secure` (адрес настройки для вашего браузера указан в настройках GyverHUB) и добавить `http://hub.gyver.ru` в список доверенных сайтов. После этого можно будет установить PWA приложение по кнопке HTTP и пользоваться им в локальном режиме!